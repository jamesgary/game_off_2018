<!DOCTYPE html>
<html>
  <head>
    <title>GAME</title>
    <link rel="stylesheet" type="text/css" href="./css/main.css">
  </head>
  <body>
    <div id="pixi"></div>
    <div id="elm-container">
      <div id="elm"></div>
    </div>
    <div id="stats"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.8.2/pixi.min.js"></script>
    <script src="./js/pixi-viewport.js"></script>
    <script src="./js/main.js"></script>
    <script>
      function init() {
        // PIXIIIIIIIIIIIIIIIIIIIII
        // PIXIIIIIIIIIIIIIIIIIIIII
        // PIXIIIIIIIIIIIIIIIIIIIII

        // Some DOM setup

        PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.NEAREST;
        var app = new PIXI.Application({
          width: window.innerWidth,
          height: window.innerHeight,
          roundPixels: true,
          resolution: 1,
        });

        var viewport = new PIXI.extras.Viewport({
          screenWidth: window.innerWidth,
          screenHeight: window.innerHeight,
          worldWidth: 20,
          worldHeight: 20 * (window.innerHeight / window.innerWidth),

          interaction: app.renderer.interaction // the interaction module is important for wheel() to work properly when renderer.view is placed or scaled
        });
        document.getElementById("pixi").appendChild(app.view);

        // Load textures

        var waterTex = PIXI.Texture.fromImage('images/water.png');
        //var grassTex = PIXI.Texture.fromImage('images/grass.png');
        var selectedTileTex = new PIXI.Sprite.fromImage('images/selectedTile.png');

        // Create sprites/containers

        var oceanBgTilingSprite = new PIXI.extras.TilingSprite(
          waterTex,
          app.screen.width,
          app.screen.height
        );
        var grassSprites = [];
        var waterSprites = [];

        var grassParticleContainer = new PIXI.particles.ParticleContainer();
        var waterParticleContainer = new PIXI.particles.ParticleContainer();

        // Add sprites to stage
        //viewport.addChild(oceanBgTilingSprite);
        viewport.addChild(grassParticleContainer);
        viewport.addChild(waterParticleContainer);
        viewport.addChild(selectedTileTex);
        app.stage.addChild(viewport);

        //app.ticker.add(function() {
        //  oceanBgTilingSprite.tileScale.x = 1;//2 + Math.sin(count);
        //  oceanBgTilingSprite.tileScale.y = 1;//2 + Math.cos(count);
        //  oceanBgTilingSprite.tilePosition.x += 0;
        //  oceanBgTilingSprite.tilePosition.y += 1.55;
        //});

        // debug stuff
        //let rectangle = new PIXI.Graphics();
        //rectangle.beginFill(0xFFCCFF);
        //rectangle.drawRect(-999, 0, 2000, 1); // x axis
        //rectangle.drawRect(0, -999, 1, 2000); // y axis
        //rectangle.endFill();
        //viewport.addChild(rectangle);
        // end debug stuff

        var persistence;

        try {
          persistence = JSON.parse(localStorage.getItem("persistence"));

          if (!persistence) { fail() }
        } catch(e) {
          persistence = null;
          localStorage.removeItem("persistence");
        }

        var app = Elm.Main.init({
          node: document.getElementById('elm'),
          flags: {
            // CHANGE ME WHEN CHANGING FLAGS
            persistence: persistence,
            timestamp: Date.now(),
            windowWidth: window.innerWidth,
            windowHeight: window.innerHeight,
          }
        });

        //let center = {x: 0, y: 0};
        let TILE_SIZE = 32;

        app.ports.performEffects.subscribe(function(effects) {
          for (let i = 0; i < effects.length; i++) {
            let effect = effects[i];

            // CHANGE ME WHEN CHANGING EFFECTS
            switch (effect.id) {
              case "SAVE":
                console.log("savin");
                console.log(effect.persistence);
                localStorage.setItem("persistence", JSON.stringify(effect.persistence));
                break;
              case "HARD_RESET":
                console.log("hard resetin");
                localStorage.removeItem("persistence");
                break;
              case "MOVE_CAMERA":
                //console.log(effect);
                //center.x = effect.x
                //center.y = effect.y
                viewport.moveCenter(effect.x, effect.y);
                break;
              case "DRAW_MAP":
                //oceanBgTilingSprite.tilePosition.x = -center.x + (window.innerWidth);
                //oceanBgTilingSprite.tilePosition.y = -center.y + (window.innerHeight);

                let waterSpriteCount = 0;
                let grassSpriteCount = 0;
                for (let i = 0; i < effect.map.length; i++) {
                  let tile = effect.map[i]; // tile.pos, tile.tile

                  let sprite;
                  switch (tile.tile) {
                    case "water":
                      if (waterSprites[waterSpriteCount]) {
                        sprite = waterSprites[waterSpriteCount];
                      } else {
                        sprite = new PIXI.Sprite.fromImage('images/water.png');
                        waterParticleContainer.addChild(sprite);
                        waterSprites[waterSpriteCount] = sprite;
                      }
                      waterSpriteCount++;
                      break;
                    case "grass":
                      if (grassSprites[grassSpriteCount]) {
                        sprite = grassSprites[grassSpriteCount];
                      } else {
                        sprite = new PIXI.Sprite.fromImage('images/grass.png');
                        grassParticleContainer.addChild(sprite);
                        grassSprites[grassSpriteCount] = sprite;
                      }
                      grassSpriteCount++;
                      break;
                    default:
                      console.error("weird tile: " + tile.tile);
                  }
                  sprite.position.set(
                    (tile.pos.x * TILE_SIZE),
                    (tile.pos.y * TILE_SIZE)
                  );
                }

                selectedTileTex.position.set(
                  TILE_SIZE * effect.selectedTile.x,
                  TILE_SIZE * effect.selectedTile.y,
                );
                break;
              default:
                //console.error("unknown effect: " + JSON.stringify(effect));
            }
          }
        });

        (function(){var script=document.createElement('script');script.onload=function(){var stats=new Stats();document.getElementById("stats").appendChild(stats.dom);requestAnimationFrame(function loop(){stats.update();requestAnimationFrame(loop)});};script.src='//rawgit.com/mrdoob/stats.js/master/build/stats.min.js';document.head.appendChild(script);})()
      }

      init();
    </script>
  </body>
</html>
